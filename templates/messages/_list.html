{% if conversation and session %}
<div class="row">
  <div class="col-xs-12">
    <h5 class="pull-left" style="margin-right: 15px;">
      <i class="icon-comment"></i>
      {% if conversations|length() > 1 %}
      Commentaires
      {% else %}
        {% with conversation.messages.count() as nb %}
          {{ nb }} Commentaire{{ nb|pluralize() }}
        {% endwith %}
      {% endif %}
    </h5>
    {% if conversations|length() > 1 %}
    <div class="dropdown">
      <a id="conversation-{{conversation.pk}}-privacy" role="button" data-toggle="dropdown" class="btn btn-sm btn-info">
        {% with conversation.messages.count() as nb %}
          {% if conversation.type == 'comments_private' %}
          <i class="icon-lock"></i> {{ nb }} Commentaire{{ nb|pluralize() }} privé{{ nb|pluralize() }}
          {% else %}
          <i class="icon-club"></i> {{ nb }} Commentaire{{ nb|pluralize() }} public{{ nb|pluralize() }}
          {% endif %}
        {% endwith %}
        <span class="caret"></span>
      </a>

      <ul class="dropdown-menu" role="menu" aria-labelledby="conversation-{{conversation.pk}}-privacy">
      {% for c in conversations %}
        {% with c.messages.count() as nb %}
        <li class="{% if c == conversation %}active{% endif %}">
          <a href="{% url conversation-list c.id %}" class="modal-action" data-replaces="messages-{{session.pk}}">
            {% if c.type == 'comments_private' %}
            <i class="icon-lock"></i> {{ nb }} Commentaire{{ nb|pluralize() }} privés
            {% else %}
            <i class="icon-club"></i> {{ nb }} Commentaire{{ nb|pluralize() }} publics
            {% endif %}
          </a>
        </li>
        {% endwith %}
      {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
</div>

{% for message in messages %}
<div class="row message actions-hover">
  <div class="col-xs-1 thumb">
    <img class="img-responsive img-rounded" src="{{ message.writer.avatar.url }}" alt="Avatar {{ message.writer.username }}" />
  </div>
  <div class="col-sm-8">
    <p>
      {% if conversation.type == 'comments_private' %}
      <i class="icon-lock do-tooltip" title="Commentaire privé"></i>
      {% endif %}
      <i class="icon-user"></i> <a href="{% url user-public-profile message.writer.username %}">{{ message.writer.first_name }} {{ message.writer.last_name }}</a>
      <i class="icon-calendar"></i> {{ message.created|date('l d E Y - H:i') }}
      {% if message.revision > 1 %}
      <i class="icon-right-open"></i> Edité {{ message.revision }} fois.
      {% endif %}
    </p>
    <blockquote>
    {{ message.message|linebreaks }}
    </blockquote>
  </div>
  <div class="col-sm-3 text-right actions">
    {% if message.writer == user %}
    <a href="{% url message-delete message.pk %}" class="modal-action btn btn-sm btn-danger"><i class="icon-trash"></i> Supprimer</a>
    <a href="{% url message-edit message.pk %}" class="modal-action btn btn-sm btn-success">Editer <i class="icon-right-open"></i></a>
    {% endif %}
  </div>
</div>
{% endfor %}

<div class="row">
  <div class="col-xs-12 actions">
    {% if user.is_authenticated() %}
      <a href="{% url conversation-add conversation.pk %}" class="btn btn-sm {% if conversation.type == 'comments_private' %}btn-warning{% else %}btn-success{% endif %} modal-action">
        <i class="icon-plus"></i> Ajouter un commentaire {% if conversation.type == 'comments_private' %}privé{% else %}public{% endif %}
      </a>
      {% if 'comments_public' in privacy and not session.comments_public %}
      <a href="{% url message-session-add session.pk, 'public' %}" class="btn btn-sm btn-success modal-action">
        Démarrer une conversation publique
      </a>
      {% endif %}
      {% if 'comments_private' in privacy and not session.comments_private %}
      <a href="{% url message-session-add session.pk, 'private' %}" class="btn btn-sm btn-warning modal-action">
        Démarrer une conversation privée
      </a>
      {% endif %}
    {% else %}
    <span class="btn btn-sm btn-info disabled do-tooltip" title="Vous devez avoir un compte pour ajouter un commentaire">
      <i class="icon-plus"></i> Ajouter un commentaire
    </span>
    {% endif %}
  </div>
</div>
{% endif %}
