{% import '_macros.html' as macros %}

{% if session.pk %}
<form id="session-{{day}}-{{session.pk}}" method="post" action="{% url sport-session-edit day.year, day.month, day.day, session.pk %}" class="form-horizontal report box">
  <input type="hidden" name="session" value="{{session.pk}}" />
{% else %}
<form id="session-{{day}}-add" method="post" action="{% url sport-session-add day.year, day.month, day.day %}" class="form-horizontal report box">
{% endif %}
  {% csrf_token %}
  {% if modal %}
  <input type="hidden" name="modal" value="true" />
  {% endif %}

  {% if saved %}
  <div class="alert alert-success hideme">
    Séance enregistrée.
  </div>
  {% endif %}

  {% with form.non_field_errors() as err %}
  {% if err %}
  <div class="alert alert-danger">
    {{ err|safe }}
  </div>
  {% endif %}
  {% endwith %}

  {{ macros.session_types_name(form, session_types) }}
  {{ macros.input(form.comment, 'Commentaire') }}
  {{ macros.race_category(form) }}

  {% if form.instance.has_garmin() %}
  {% with form.instance.garmin_activity as act %}
  <div class="form-group row">
    <label class="control-label col-sm-2 hidden-xs"><i class="icon-location"></i> Garmin</label>
    <div class="col-sm-3 col-xs-6">
      <div class="input-group ">
        <span class="input-group-addon input-sm">Temps</span>
        <input class="form-control input-sm" disabled="disabled" value="{{ act.time }}" />
      </div>
    </div>
    <div class="col-sm-3 col-xs-6">
      <div class="input-group ">
        <span class="input-group-addon input-sm">Distance</span>
        <input class="form-control input-sm" disabled="disabled" value="{{ act.distance|default(0)|floatformat(2)}} km" />
      </div>
    </div>
    <div class="col-sm-4 col-xs-12 actions">
      <a href="{{ act.get_url() }}" target="_blank" class="pull-right btn btn-sm btn-success">Détails <i class="icon-right-open"></i></a>
    </div>
  </div>
  {% endwith %}
  {% endif %}

  <div class="form-group row">
    {% if modal %}
    <div class="col-xs-12">
    {% else %}
    <label class="control-label col-sm-2 hidden-xs">Sport</label>
    <div class="col-sm-10 col-xs-12">
    {% endif %}

      <div class="form-group sport-session row">
        <div class="col-sm-2 hidden-xs">
          {{ macros.sport_session(form) }}
        </div>

        {{ macros.input_prepend(form.time, 'Temps') }}
        {{ macros.input_prepend(form.distance, 'Distance') }}

        <div class="col-sm-4 col-xs-12 actions">
          <button type="submit" class="pull-right btn btn-sm btn-primary" >Sauver<span class="hidden-xs"> {% if not modal %}la séance {% endif %}</span><i class="icon-right-open"></i></button>
          {% if session.pk %}
          <a href="{% url sport-session-delete day.year, day.month, day.day, form.instance.pk %}" class="modal-action pull-right btn btn-sm btn-danger"><i class="icon-trash"></i><span class="hidden-xs">{% if not modal %}Supprimer{% endif %}</span></a>
          {% endif %}

          <div class="visible-xs">
            {{ macros.sport_session(form) }}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if session.pk %}
  <div class="comments">

    <div class="row">
      <div class="col-sm-10 col-sm-offset-2">
      {% with session.comments.count() as nb %}
        {% if nb > 0 %}
        <h4>{{ nb }} commentaire{{ nb|pluralize() }}</h4>
        {% else %}
        <h4>Pas de commentaires</h4>
        {% endif %}
      {% endwith %}
      </div>
    </div>

    {% with session.comments.order_by('created') as comments %}
      {% for comment in comments %}
      <div class="row">
        <div class="col-sm-1 col-sm-offset-1">
          <img class="img-responsive img-rounded" src="{{ comment.sender.avatar.url }}" alt="Avatar {{ comment.sender.username }}" />
        </div>
        <div class="col-sm-8">
          <p>
            <i class="icon-user"></i> <a href="{% url user-public-profile comment.sender.username %}">{{ comment.sender.first_name }} {{ comment.sender.last_name }}</a>
            <i class="icon-calendar"></i> {{ comment.created|date('l d E Y - H:i') }}
            {% if comment.revision > 1 %}
            <i class="icon-right-open"></i> Edité {{ comment.revision }} fois.
            {% endif %}
          <P>
          <blockquote>
          {{ comment.message }}
          </blockquote>
        </div>
      </div>
      {% endfor %}
    {% endwith %}

    <div class="row">
      <div class="col-sm-10 col-sm-offset-2">
        <a href="{% url message-session-add session.id %}" class="btn btn-sm btn-info modal-action">Ajouter un commentaire</a>
      </div>
    </div>
  </div>
  {% endif %}

</form>
